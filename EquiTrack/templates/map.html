{% extends "base.html" %}

{% block content %}
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css"/>
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.ie.css" />
    <![endif]-->
    <!--Switch between the different themes changing the stylesheet below - light-theme.css |dark-theme.css -->
    <link rel="stylesheet" href="{{ STATIC_URL }}css/dark-theme.css">
    <link rel="stylesheet" href="{{ STATIC_URL }}css/makeitresponsive.css">
    <link rel="stylesheet" href="{{ STATIC_URL }}css/spongemap.css" />
    <section class="main-content-wrapper">
        <section id="main-content">
            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <div id="leaflet-map"></div>
                            <div id="layer_selector" class="cartodb-infobox">
                              <ul>
                                {% for table in tables %}
                                    <li data="{{ table.table_name }}"
                                        {% if forloop.first %}
                                            class="selected"
                                        {% endif %}
                                        >
                                        {{ table.table_name }}
                                    </li>
                                {% endfor %}
                              </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script>
            <!--<script src="App.js"></script> -->
            <!--Change the URL below in order to change the map that is being shown.
            Go to your map in CartoDB, click on share, and copy the URL undert the API section
            Check the cartodb.js documentation for more info
            http://developers.cartodb.com/documentation/cartodb-js.html-->
            <script>

                function createSelector(layer) {

                    var $options = $('#layer_selector li');
                    $options.click(function (e) {
                        // get the area of the selected layer
                        var $li = $(e.target);
                        var area = $li.attr('data');

                        // deselect all and select the clicked one
                        $options.removeClass('selected');
                        $li.addClass('selected');

                        // create query based on data from the layer
                        var query = "select * from "+ area;

                        // change the query in the layer to update the map
                        layer.setSQL(query);
                    });
                }

                function main() {
                    // create layer selector
                    var map = L.map('leaflet-map', {
                        zoomControl: true,
                        center: [33.9, 36],
                        zoom: 9,
                        layers: [
                            L.tileLayer(
                                    'http://otile1.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpg', {
                                        attribution: 'Tiles Courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png">'
                                    }
                            )
                        ]
                    });

                    var $options = $('#layer_selector li');

                    {% for table in tables %}

                    cartodb.createLayer(
                            map,
                            {
                                user_name: '{{ table.domain }}',
                                type: 'cartodb',
                                sublayers: [
                                    {
                                        sql: "SELECT * FROM {{ table.table_name }}",
                                        cartocss: '#{{ table.table_name }} {marker-fill: #c5e3fd;}',
                                        interactivity: '{{ table.name_col }}, {{ table.code_col }}'
                                    }]
                            })
                        .addTo(map)
                        .on('done', function(layer) {
                                var sublayer = layer.getSubLayer(0);

                                cdb.vis.Vis.addInfowindow(map, sublayer, ['cartodb_id', '{{ table.name_col }}', '{{ table.code_col }}'], {
                                     // we provide a nice default template, if you want yours uncomment this
                                     //infowindowTemplate: $('#infowindow_template').html()
                                   });
                                   sublayer.setInteraction(true);

                                layer.hide();
                                var option = $("#layer_selector li[data={{ table.table_name }}]");
                                option.click(function (e) {
                                    if (option.hasClass('selected')) {
                                        layer.hide();
                                        option.removeClass('selected');
                                    }
                                    else {
                                        layer.show();
                                        option.addClass('selected');
                                    }
                                });
                            });
                    {% endfor %}

                    $.get("{% url 'locations' %}", function (data) {
                        $.each(data, function (index, location) {
                            var marker_content = '\
                                <h4 style="font-weight: strong;">' + location.pca_number + '</h4>\
                                <table cellpadding="4" cellspacing="0" border="0">\
                                    <tr>\
                                        <td style="vertical-align:top; white-space:nowrap;">PCA title:</td>\
                                        <td style="vertical-align:top;">' + location.pca_title + '</td>\
                                    </tr>\
                                    <tr>\
                                        <td style="vertical-align:top; white-space:nowrap;">Gateway:</td>\
                                        <td style="vertical-align:top;">' + location.gateway_name + '</td>\
                                    </tr>\
                                    <tr>\
                                        <td style="vertical-align:top; white-space:nowrap;">Partner:</td>\
                                        <td style="vertical-align:top;">' + location.partner_name + '</td>\
                                    </tr>\
                                    <tr>\
                                        <td style="vertical-align:top; white-space:nowrap;">Sector:</td>\
                                        <td style="vertical-align:top;">' + location.sector_name + '</td>\
                                    </tr>\
                                </table>\
                                ';
                            var marker = L.marker(new L.LatLng(location.latitude, location.longitude));
                            marker.bindPopup(marker_content);
                            marker.addTo(map)
                        });
                    });
                }

                window.onload = main;
            </script>
        </section>
    </section>


{% endblock %}