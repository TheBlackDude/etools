{% extends "base.html" %}
{% load leaflet_tags %}

{% block extra_head %}


    {% leaflet_css %}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/leaflet.awesome-markers.css" />
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />

    <script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script>
    <script src="{{ STATIC_URL }}js/leaflet.awesome-markers.min.js"></script>

    <!--[if lte IE 8 -->
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.ie.css" />
    <![endif]-->
    <!--Switch between the different themes changing the stylesheet below - light-theme.css |dark-theme.css -->
   <!-- <link rel="stylesheet" href="{{ STATIC_URL }}css/dark-theme.css"> -->
    <link rel="stylesheet" href="{{ STATIC_URL }}css/makeitresponsive.css">
    <link rel="stylesheet" href="{{ STATIC_URL }}css/spongemap.css" />
    <link rel="stylesheet" href="{{ STATIC_URL }}css/leaflet.awesome-markers.css" />

    <style>
        html, body {height:100%; padding: 0;}
        #cartodb-map {height:100%; margin-left: 250px; background: white;}
        #mapmenu { position: absolute; top: 10px; right: 10px; height:60px; background: transparent; z-index:10;}
        #mapmenu a {
          margin: 15px 10px 0 0;
          float: right;
          vertical-align: baseline;
          width: 100px;
          padding: 10px;
          text-align: center;
          font: bold 11px "Helvetica",Arial;
          line-height: normal;
          color: #FFF;
          border-radius: 4px;
          border: 1px solid #777777;
          /*background: #ffffff; */
          text-decoration: none;
          cursor: pointer;
        }
        #mapmenu a.selected {
           background: #777; }
        #mapmenu a:hover {
          color: #f09;
        }

        .infowindow-custom{
            position: relative;
            width: 500px;
            background-color: white;
            margin-bottom: 11px;

          }

        .cartodb-popup-close-button {
            position: absolute;
            top: -12px;
            right: -11px;
            width: 26px;
            height: 26px;
            background: url('http://libs.cartodb.com/cartodb.js/v3/themes/img/light.png') no-repeat 0 -23px;
            text-indent: -9999px;
            font-size: 0;
            line-height: 0;
            opacity: 1;
            text-transform: uppercase;
            z-index: 3;
          }

          .cartodb-popup-tip-container {
            position: absolute;
            bottom: -3px;
            left: 23px;
            width: 16px;
            height: 14px;
            background: url('http://libs.cartodb.com/cartodb.js/v3/themes/img/light.png') no-repeat -23px -7px;
            text-indent: -9999px;
            font-size: 0;
            line-height: 0;
            opacity: 1;
            z-index: 3;
          }

          blockquote {
            display: hidden;
          }

          .cartodb-popup-content {
            min-height: 100px;
          }
        .leaflet-popup-content{
        min-width: 400px !important;
        width: inherit !important;
        height: 500px;
            height: inherit !important;
    }

    .scrollable-menu {
        height: auto;
        max-height: 500px;
        overflow-x: hidden;
    }
    </style>

{% endblock %}

{% block content %}


    <section class="main-content-wrapper">
        <section id="main-content">
           <div class="row col-md-offset-1" style=" padding-top: 10px;">
            <div class="col-md-2">
                <div class="btn-group btn-block">
                    <button id="btn-result-structure" type="button" class="col-md-10 btn btn-info">
                       Result Structure
                    </button>

                    <button class="col-md-2 btn btn-info dropdown-toggle" data-toggle="dropdown">
                         <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu scrollable-menu" role="menu">
                        {% for result_structure in result_structure_list %}
                            <li><a href="javascript:void(0);" id="result_structure{{ result_structure.id }}" onclick="DropdownSelect(this.id);" itemid="{{ result_structure.id }}">{{ result_structure.name }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
           <div class="col-md-2">
                <div class="btn-group btn-block">
                    <button id="btn-sector" type="button" class="col-md-10 btn btn-danger">
                       Sector
                    </button>

                    <button class="col-md-2 btn btn-danger dropdown-toggle" data-toggle="dropdown">
                         <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu scrollable-menu" role="menu">
                        {% for sector in sectors_list %}
                            <li><a href="javascript:void(0);" id="sector{{ sector.id }}" onclick="DropdownSelect(this.id);" itemid="{{ sector.id }}">{{ sector.name }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="col-md-2">
                <div class="btn-group btn-block">
                    <button id="btn-gateway" type="button" class="col-md-10 btn btn-primary">
                       Gateways
                    </button>

                    <button class="col-md-2 btn btn-primary dropdown-toggle" data-toggle="dropdown" type="button">
                         <span class="caret"></span>
                    </button>

                    <ul class="dropdown-menu scrollable-menu" role="menu" id="gateway_ul">
                        {% for gateway in gateway_list %}
                            <li><a href="javascript:void(0);" id="gateway{{ gateway.id }}" onclick="DropdownSelect(this.id);" itemid="{{ gateway.id }}">{{ gateway.name }}</a></li>
                        {% endfor %}
                    </ul>

                </div>
            </div>
            <div class="col-md-2">
                <div class="btn-group btn-block">
                    <button id="btn-governorate" type="button" class="col-md-10 btn btn-success">
                       Governorate
                    </button>

                    <button class="col-md-2 btn btn-success dropdown-toggle" data-toggle="dropdown" type="=button">
                         <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu scrollable-menu" role="menu" id="governorate_ul">
                       {% for governorate in governorate_list %}
                            <li><a href="javascript:void(0);" id="governorate{{ governorate.id }}" onclick="DropdownSelect(this.id);" itemid="{{ governorate.id }}">{{ governorate.name }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="col-md-2 col-md-offset-2">
                <div class="btn-group btn-block">
                    <button id="btn-submit" type="button" class="col-md-5 btn btn-warning" onclick="SubmitSearch();">
                       Submit
                    </button>
                    <button id="btn-clear" type="button" class="col-md-5 btn btn-danger" onclick="ClearButtonClick();">
                       Clear
                    </button>
                </div>
            </div>

            </div>

            <!-- new row -->
            <div class="row col-md-offset-1">
                <div class="col-md-2">
                    <div class="btn-group btn-block">
                        <button id="btn-status" type="button" class="col-md-10 btn btn-info">
                           Status
                        </button>

                        <button class="col-md-2 btn btn-info dropdown-toggle" data-toggle="dropdown" type="=button">
                             <span class="caret"></span>
                        </button>
                            <ul class="dropdown-menu scrollable-menu" role="menu">
                                    <li><a href="javascript:void(0);" id="status0" onclick="DropdownSelect(this.id);" itemid="0">IN_PROCESS</a></li>
                                    <li><a href="javascript:void(0);" id="status1" onclick="DropdownSelect(this.id);" itemid="1">ACTIVE</a></li>
                                    <li><a href="javascript:void(0);" id="status2" onclick="DropdownSelect(this.id);" itemid="2">IMPLEMENTED</a></li>
                                    <li><a href="javascript:void(0);" id="status3" onclick="DropdownSelect(this.id);" itemid="3">CANCELLED</a></li>
                            </ul>
                    </div>
                </div>
               <div class="col-md-2">
                    <div class="btn-group btn-block">
                        <button id="btn-donor" type="button" class="col-md-10 btn btn-danger">
                           Donor
                        </button>

                        <button class="col-md-2 btn btn-danger dropdown-toggle" data-toggle="dropdown">
                             <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu scrollable-menu" role="menu">
                           {% for donor in donor_list %}
                                <li><a href="javascript:void(0);" id="donor{{ donor.id }}" onclick="DropdownSelect(this.id);" itemid="{{ donor.id }}">{{ donor.name }}</a></li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="btn-group btn-block">
                        <button id="btn-partner" type="button" class="col-md-10 btn btn-primary">
                           Partner
                        </button>

                        <button class="col-md-2 btn btn-primary dropdown-toggle" data-toggle="dropdown">
                             <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu scrollable-menu" role="menu">
                           {% for partner in partner_list %}
                                <li><a href="javascript:void(0);" id="partner{{ partner.id }}" onclick="DropdownSelect(this.id);" itemid="{{ partner.id }}">{{ partner.name }}</a></li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="btn-group btn-block">
                        <button id="btn-district" type="button" class="col-md-10 btn btn-success">
                           District
                        </button>

                        <button class="col-md-2 btn btn-success dropdown-toggle" data-toggle="dropdown">
                             <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu scrollable-menu" role="menu">
                           {% for district in region_list %}
                                <li><a href="javascript:void(0);" id="district{{ district.id }}" onclick="DropdownSelect(this.id);" itemid="{{ district.id }}">{{ district.name }}</a></li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>

        <!-- new row -->
            <div class="row col-md-11 col-md-offset-1" style="display:block">
                <div id="accordion" class="panel-group">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">Detailed Search</a>
                            </h4>
                        </div>
                         <div id="collapseOne" class="panel-collapse collapse">
                            <div class="panel-body">
                                <div class="col-md-2">
                                    <div class="btn-group btn-block">
                                        <button id="btn-indicator" type="button" class="col-md-10 btn btn-info">
                                           Indicator
                                        </button>

                                        <button class="col-md-2 btn btn-info dropdown-toggle" data-toggle="dropdown">
                                             <span class="caret"></span>
                                        </button>
                                        <ul class="dropdown-menu scrollable-menu" role="menu">
                                           {% for indicator in indicator_list %}
                                                <li><a href="javascript:void(0);" id="indicator{{ indicator.id }}" onclick="DropdownSelect(this.id);" itemid="{{ indicator.id }}">{{ indicator.name }}</a></li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="btn-group btn-block">
                                        <button id="btn-output" type="button" class="col-md-10 btn btn-success">
                                           Output
                                        </button>

                                        <button class="col-md-2 btn btn-success dropdown-toggle" data-toggle="dropdown">
                                             <span class="caret"></span>
                                        </button>
                                        <ul class="dropdown-menu scrollable-menu" role="menu">
                                           {% for output in output_list %}
                                                <li><a href="javascript:void(0);" id="output{{ output.id }}" onclick="DropdownSelect(this.id);" itemid="{{ output.id }}">{{ output.name }}</a></li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>

                                <div class='col-md-3'>
                                    <div class="form-group">
                                        <label class="col-md-2 control-label nopadding">Date From</label>
                                        <div class='input-group input-append date col-md-10' id='datetimepicker6'>
                                            <input type='text' class="form-control" name="date" />
                                            <span class="input-group-addon add-on"><span class="glyphicon glyphicon-calendar"></span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class='col-md-3'>
                                    <div class="form-group">
                                        <label class="col-md-2 control-label no nopadding">Date To</label>
                                        <div class='input-group input-append date col-md-10' id='datetimepicker7'>
                                            <input type='text' class="form-control" name="date" />
                                            <span class="input-group-addon add-on"><span class="glyphicon glyphicon-calendar"></span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                             </div>
                         </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-default">
                        <div class="panel-body">

                             {% leaflet_map "leaflet-map" callback="window.main" %}

                            <div id='mapmenu' class="col-md-10">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </section>


{% endblock %}

{% block extra_js %}

    {% leaflet_js %}

    <script type="text/javascript">

        //querying JSON
        function getObjects(obj, key, val) {
            var objects = [];
            for (var i in obj) {
                if (!obj.hasOwnProperty(i)) continue;
                if (typeof obj[i] == 'object') {
                    objects = objects.concat(getObjects(obj[i], key, val));
                } else if (i == key && obj[key] == val) {
                    objects.push(obj);
                }
            }
            return objects;
        }

        function DropdownSelect(id){
            var selectVal = $('#' + id).html();
            var itemId = $('#' + id).attr('itemid');
            var btnId = "btn-" + id.substring(0, id.indexOf(itemId));
            $('#' + btnId).html(selectVal);

            //get the current color class and set the background of selected item
            var colorClass = '';
            var arr =  $('#' + btnId).attr('class').split(" ");

            for (var i = 0; i < arr.length; i++){
                if(arr[i].indexOf("btn-")>-1){
                    colorClass = arr[i];
                    break;
                }
            }
            $('#' + btnId).next().next().find('*').removeClass(colorClass);
            $('#' + btnId).next().next().find('*').css({"color": ""});

            $('#' + id).addClass(colorClass);
            $('#' + id).css({"color" : "#fff"})
        }

        function SubmitSearch(){
            var resultStructure = $('#btn-result_structure').html();
            var sector = $('#btn-sector').html();
            var gateway = $('#btn-gateway').html();
            var governorate = $('#btn-governorate').html();
            var status = $('#btn-status').html();
            var donor = $('#btn-donor').html();
            var partner = $('#btn-partner').html();
            var district = $('#btn-district').html();

            var query='';
            if(!resultStructure.includes('Result Structure'))
                query += 'result_structure=' + $("a:contains(" + resultStructure + ")").attr("itemid") + '&';

            if(!sector.includes('Sector'))
                query += 'sector=' + $("a:contains(" + sector + ")").attr("itemid") + '&';

            if(!gateway.includes('Gateways'))
                query += 'gateway=' + $("a:contains(" + gateway + ")").attr("itemid") + '&';

            if(!governorate.includes('Governorate'))
                query += 'governorate=' + $("a:contains(" + governorate + ")").attr("itemid") + '&';

            if(!status.includes('Status'))
                query += 'status=' + $("a:contains(" + status + ")").html().toLowerCase() + '&';

            if(!donor.includes('Donor'))
                query += 'donor=' + $("a:contains(" + donor + ")").attr("itemid") + '&';

            if(!partner.includes('Partner'))
                query += 'partner=' + $("a:contains(" + partner + ")").attr("itemid") + '&';

            if(!district.includes('District'))
                query += 'district=' + $("a:contains(" + district + ")").attr("itemid") + '&';

            history.pushState(query, "", "/map/?" + query);
            console.log(query);

        }

        function ClearButtonClick(){
            history.replaceState("", "", "/map/");
            location.reload();
        }

        //sample PCA json function
        var pca_locations1 = [
    {
        "latitude": 33.88354923,
        "longitude": 35.99393762,
        "location_name": "#N/A",
        "location_type": "School",
        "gateway_id": 1,
        "parterships": [
            {
                "pca_title": "Inclusive and enabling learning environment for displaced Syrians and underprivileged Lebanese Learners",
                "pca_number": "PCA/LEBA/2013/46",
                "pca_id": 25,
                "partner_name": "IQRA",
                "partner_id": 19,
                "sectors": [
                    {
                        "sector_name": "Education",
                        "sector_id": 1,
                        "indicators": [
                            {
                                "indicator": " # of children in non-formal learning opportunities (girls and boys) ",
                                "programmed": 5000,
                                "current": 0,
                                "unit": "Children",
                                "id": 60,
                                "pca_sector": 28
                            },
                            {
                                "indicator": "# of children in psycho-social support in formal and non-formal education (girls and boys)",
                                "programmed": 5000,
                                "current": 0,
                                "unit": "Children",
                                "id": 61,
                                "pca_sector": 28
                            }
                        ],
                        "id": 28,
                        "pca": 25,
                        "sector": 1
                    }
                ],
                "id": 25,
                "agreement_type": "pca",
                "result_structure": 1,
                "number": "PCA/LEBA/2013/46",
                "title": "Inclusive and enabling learning environment for displaced Syrians and underprivileged Lebanese Learners",
                "status": "active",
                "partner": 19,
                "start_date": "2013-10-01",
                "end_date": "2014-06-30",
                "initiation_date": "2013-10-01",
                "signed_by_unicef_date": "2014-10-11",
                "signed_by_partner_date": "2013-10-11",
                "unicef_mng_first_name": "Kumiko",
                "unicef_mng_last_name": "Iwasawa",
                "unicef_mng_email": "kiwasawa@unicef.org",
                "partner_mng_first_name": "Amina",
                "partner_mng_last_name": "Kleit",
                "partner_mng_email": "",
                "partner_contribution_budget": 67200,
                "unicef_cash_budget": 930213,
                "in_kind_amount_budget": 56494,
                "cash_for_supply_budget": 873719,
                "total_cash": 1053907,
                "current": false,
                "created_at": "2013-12-16T22:00:00Z",
                "updated_at": "2014-03-24T12:50:00.316Z",
                "amendment": false,
                "amended_at": null,
                "amendment_number": 0,
                "original": null,
                "unicef_managers": []
            }
            $('#' + btnId).next().next().find('*').removeClass(colorClass);
            $('#' + btnId).next().next().find('*').css({"color": ""});

        function getRandomColor() {
            var letters = '0123456789ABCDEF'.split('');
            var color = '#';
            for (var i = 0; i < 6; i++ ) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        var map1;
        var sublayer;
        var table;
        var uniqueID;
        //var sublayerArr = [];
        var subLayerOptions = '[';
        var count = 0;
        var tableArr = [];
        //var cartoSubLayers = [];
        var color="";
        //var layers = {};

        function main(map, options) {
            map1=map;
            layer_control = L.control.layers().addTo(map);
            //get all cartodb tables from equitrack and pull data from CartoDB
            $.getJSON("{% url 'cartodbtables' %}", function (data) {
                $.each(data, function (key, val) {
                    $.getJSON(
                            "https://"+ val.domain +".cartodb.com/api/v2/sql?q=SELECT * FROM " + val.table_name +
                            "&format=GeoJSON&api_key=" + val.api_key
                    )
                    .done(function (data) {
                        var newlayer;
                        var color = getRandomColor();
                        if (data.features[0].geometry != null) {
                            if (data.features[0].geometry.type == "MultiPolygon" || data.features[0].geometry.type == "Polygon") {
                                newlayer = L.geoJson(data, {
                                    style: {
                                        color: "#fff",
                                        weight: 2,
                                        opacity: 0.5,
                                        fillOpacity: 0.3,
                                        fillColor: color
                                    }
                                });
                            }
                            else{

                                newlayer = L.geoJson(data, {
                                    style: function (feature) {
                                        return feature.properties && feature.properties.style;
                                    },

                                    pointToLayer: function (feature, latlng) {
                                        return L.circleMarker(latlng, {
                                            radius: 5,
                                            fillColor: color,
                                            color: "#fff",
                                            weight: 1,
                                            opacity: 1,
                                            fillOpacity: 0.8
                                        });
			                        }
                                 });
                            }
                        }
                        else{
                            //var color = getRandomColor();
                            newlayer = L.geoJson(data, {
                                style: function (feature) {
                                    return feature.properties && feature.properties.style;
                                },

                                pointToLayer: function (feature, latlng) {
                                    return L.circleMarker(latlng, {
                                        radius: 5,
                                        fillColor: color,
                                        color: "#fff",
                                        weight: 1,
                                        opacity: 1,
                                        fillOpacity: 0.8
                                    });
                                }
                             });
                        }
                        //console.log(JSON.stringify(data));
                        layer_control.addOverlay(newlayer, val.table_name);
                        $.each(tableArr, function(keyt,valt) {
                            //alert($("span:contains(" + valt.table_name + ")").html());
                            $("span:contains(" + valt.table_name + ")").parent().css({"background-color": valt.color, "opacity": "0.6"});
                            $("span:contains(" + valt.table_name + ")").css("color", "#fff");
                        });
                    })
                    .error(function (errors) {
                        // errors contains a list of errors
                        console.log("errors:" + errors);
                    });
                });
                $('.leaflet-top.leaflet-right').prepend('<div>Select Layers</div>');
            });

            UpdateMap();
        }

        function GatewayGetData(id){
            if(id==''){

            }
            else{
                var rowId = id.substring(id.length-1);
                var url = "/nikmap/" + rowId + "/all_json_governorates";
                $.getJSON(url, function (governorates) {
                     var options = '';
                     for (var i = 0; i < governorates.length; i++) {
                        options += '<li><a href="javascript:void(0);" id="governorate' + governorates[i].pk + '" onclick="GovernorateGetData(this.id);">' + governorates[i].fields['name'] + '</a></li>';
                     }
                     $("#governorate_ul").html(options);
                });
            }
            UpdateMap();
        }

        //getting all pcodes and creating SQL statement
                //getting all pcodes and creating SQL statement
        function UpdateMap(){
           // $.each(tableArr, function (key, val){
            var layerGr = new L.layerGroup();
                var pca_qry = getObjects(pca_locations1, 'gateway_id', '9');
                //var sql_stmt = "SELECT * FROM " + val.table_name + " WHERE " + val.pcode_col + " IN (";
                var count = 0;
                $.each( pca_qry, function( keyq, valueq ) {
                    var popup_content_start = "<div class='row col-md-12'><label class='col-md-3 control-label'>Location</label><div id='location_name' class='col-md-9'>" + valueq.location_name + "</div></div>" +
                                    "<div class='row col-md-12'><label class='col-md-3 control-label'>Gateway</label><div id='location_type' class='col-md-9'>" + valueq.location_type + "</div></div>" +
                                    "<div class='row col-md-12'><label class='col-md-8 control-label'>PCAs associated with this location:</label><div id='PCAs' class='col-md-4'>" +  "</div></div>" +
                            '<div class="content" id="mytab" style="padding:20px col-md-11">' +
                                                '<div role="tabpanel">';
                    var popup_content_navs = '<ul class="nav nav-tabs nav-justified" role="tablist" id="myTab">';
                    var popup_content_tabs = '<div class="tab-content" id="infotabs">';
                    var popup_content='';
                    //looping through all PCAs for one location
                    $.each( valueq.parterships, function( keyp, valuep ) {
                            popup_content_navs += '<li id="link' + keyp + '" class=""><a data-toggle="tab" href="#tab' + keyp + '">' + valuep.pca_number + '</a></li>';
                            popup_content_tabs += "<div role='tabpanel' class='tab-pane fade in' id='tab" + keyp + "' style='padding-top: 5px;'>" +
                            "<div class='row'>" +
                                "<div class='row col-md-12'><label class='col-md-3 control-label'>Title</label><div id='pca_title' class='col-md-9'>" + valuep.pca_title + "</div></div>" +
                                "<div class='row col-md-12'><label class='col-md-3 control-label'>Partner</label><div id='partner_name' class='col-md-9'>" + valuep.partner_name + "</div></div>" +
                                "<div class='row col-md-12'><label class='col-md-10 control-label'>Results by Sector:</label><div id='partner_name' class='col-md-2'></div></div>" +
                            "</div>";


                            //looping for sectors for one PCA
                            $.each( valuep.sectors, function( keys, valueSec ) {
                                var popup_content_tabs_indicator='';

                                var popup_content_tabs_sec =  '<div class="row"><div class="panel-group col-md-12" id="accordion">' +
                                                                    '<div class="panel panel-default">' +
                                                                        '<div class="panel-heading">' +
                                                                            '<h3 class="panel-title"><a data-toggle="collapse" data-parent="#accordion" href="#collapse' + keyp + keys + '">' + valueSec.sector_name +'</a></h3>' +
                                                                        '</div>' +
                                                                        '<div id="collapse' + keyp + keys + '" class="panel-collapse collapse">';

                                $.each( valueSec.indicators, function( keyi, valuei ) {
                                    popup_content_tabs_indicator +=
                                                                        '<div class="panel-body">' +
                                                                            '<a href=""><span class="sublabel">' + valuei.indicator+ '</span></a>' +                                                                        '<div><span class="sublabel" style="float: right;">Programmed: ' + valuei.programmed + '</span></div>' +
                                                                            '<div><span class="sublabel">Reached: ' + valuei.current + '</span></div>' +
                                                                            '<div class="progress progress-striped">' +
                                                                                '<div class="progress-bar progress-bar-blue" style="width: ' + valuei.current/valuei.programmed*100 +'%">' + valuei.current/valuei.programmed*100 + '% </div>' +
                                                                            '</div>' +
                                                                        '</div>';
                                });
                                popup_content_tabs_indicator += '</div>' + '</div>' + '</div>' + '</div> </div>';

                            popup_content_tabs += popup_content_tabs_sec + popup_content_tabs_indicator;
                            //console.log(popup_content_tabs);
                            });
                    });
                    popup_content_navs += '</ul>';
                    popup_content_tabs += '</div>';
                    popup_content = popup_content_start + popup_content_navs + popup_content_tabs + '</div></div>';

                    var RedIcon = L.icon({
                        iconUrl: '../static/img/marker-icon.png'
                    });
                    var marker = L.marker(new L.LatLng(valueq.latitude, valueq.longitude), {icon: RedIcon});
                    marker.bindPopup(popup_content);
                    layerGr.addLayer(marker);


{#                    var marker = L.marker(new L.LatLng(valueq.latitude, valueq.longitude)#}
{#                            , {#}
{#                        icon: L.AwesomeMarkers.icon({#}
{#                            icon: 'building-o',#}
{#                            prefix: 'fa',#}
{#                            markerColor: 'blue'#}
{#                        })#}
{#                    });#}
                    //var marker = L.marker(new L.LatLng(value.latitude, value.longitude), {icon: redMarker});

                    //marker.addTo(map1);
                });
                layer_control.addOverlay(layerGr, "Search Results");
                layerGr.addTo(map1);
                console.log(JSON.stringify(layerGr.toGeoJSON()));

                //create tabs in info window
                $("#myTab a").click(function (e) {
                    alert("tab");
                    e.preventDefault();
                    $(this).tab('show');
                });
           // });
        }

    </script>

    <script type="text/javascript">
        $(document).ready(function() {
            $('#datetimepicker6').datepicker({ format: 'mm/dd/yyyy' });
            $('#datetimepicker7').datepicker({ format: 'mm/dd/yyyy' });

            $("#datetimepicker6").on("dp.change",function (e) {
                $('#datetimepicker7').data("DateTimePicker").minDate(e.date);
            });
            $("#datetimepicker7").on("dp.change",function (e) {
                $('#datetimepicker6').data("DateTimePicker").maxDate(e.date);
            });
        });
    </script>


{% endblock %}
